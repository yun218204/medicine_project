<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç”¨è—¥ç´€éŒ„</title>
    <link rel="stylesheet" href="/css/medicinerecord.css" />
  </head>
  <body>
    <nav class="navbar">
      <div class="logo">Personal Health</div>
      <ul class="navbar-links">
        <li><a href="/">é¦–é </a></li>
        <li><a href="/medicinerecord">ç”¨è—¥ç´€éŒ„</a></li>
        <li><a href="/healthy">é¤Šç”Ÿå°ˆæ¬„</a></li>
        <li><a href="contact">è¯çµ¡æˆ‘å€‘</a></li>
      </ul>
    </nav>

    <main>
      <section class="banner">
        <!-- <img src="https://i.imgur.com/gOoeiAc.jpg" alt="å¥åº·æ°´æœç›¤" /> -->
        <div class="banner-text">
          <h1>å¥åº·ç”Ÿæ´»ï¼Œç°¡å–®é–‹å§‹</h1>
          <p>Healthy living, made simple</p>
          <% if (nickname) { %>
          <div class="user-info">
            <p class="user"><%= nickname %> æ­¡è¿ç´€éŒ„æ‚¨çš„ç”¨è—¥ï¼</p>
            <a href="/logout" class="logout-button">ç™»å‡º</a>
          </div>
          <% }%>
        </div>
      </section>
      <div class="button-group">
        <button class="fancy-button" onclick="showRecord()">ç”¨è—¥ç´€éŒ„</button>
        <button class="fancy-button" onclick="showHistory()">æ­·å²ç´€éŒ„</button>
      </div>
      <div class="slider-container">
        <!-- å·¦é‚Š -->
        <div id="recordPanel" class="panel record-panel">
          <h2>ç”¨è—¥ç´€éŒ„</h2>
          <div class="medicine-form">
            <!-- è—¥å“åç¨± -->
            <label for="medicineName">è—¥å“åç¨±ï¼š</label>
            <input type="text" id="medicineName" placeholder="è«‹è¼¸å…¥è—¥å“åç¨±" />

            <!-- æ™‚æ®µé¸æ“‡ -->
            <label>æœè—¥æ™‚é–“ï¼š</label>
            <div class="time-options">
              <label
                ><input type="radio" name="time" value="morning" /> æ—©ä¸Š</label
              >
              <label
                ><input type="radio" name="time" value="noon" /> ä¸­åˆ</label
              >
              <label
                ><input type="radio" name="time" value="evening" /> æ™šä¸Š</label
              >
            </div>

            <!-- æ—¥æœŸé¸æ“‡ -->
            <label for="medDate">æœè—¥æ—¥æœŸï¼š</label>
            <input type="date" id="medDate" />

            <!-- æ–°å¢ç´€éŒ„æŒ‰éˆ• -->
            <button class="submit-btn">æ–°å¢ç´€éŒ„</button>
          </div>
        </div>
        <!-- ç™½è‰²æ­·å²ç´€éŒ„å€å¡Š -->
        <div id="historyStaticPanel" class="panel history-static-panel">
          <h2><%= nickname %>ï¼Œé€™æ˜¯æ‚¨çš„æ­·å²ç”¨è—¥ç´€éŒ„</h2>
          <div id="historyList" class="history-list">
            <% logs.forEach((log) => { %>
            <div class="history-item" data-id="<%= log.id %>">
              ğŸ’Š <%= log.medicine_name %>ï¼ˆè¨˜éŒ„æ™‚é–“ï¼š<%=
              log.created_at.toLocaleString() %>ï¼‰
              <button class="delete-btn" onclick="deleteLog(<%= log.id %>)">
                ğŸ—‘ åˆªé™¤
              </button>
            </div>
            <% }) %>
          </div>
        </div>
        <!-- å³é‚Š -->
        <div id="historyPanel" class="panel history-panel">
          <h2>æ­·å²ç´€éŒ„</h2>
        </div>
      </div>
    </main>

    <footer></footer>
  </body>
  <script>
                  function showHistory() {
                    const historyPanel = document.getElementById("historyPanel");
                    historyPanel.classList.add("slide-in");
                  }

                  function showRecord() {
                    const historyPanel = document.getElementById("historyPanel");
                    historyPanel.classList.remove("slide-in");
                  }
                  //æ–°å¢ç´€éŒ„


                const historyData = <%- JSON.stringify(logs) %>;
              document.querySelector(".submit-btn").addEventListener("click", () => {
                const name = document.getElementById("medicineName").value.trim();
                const date = document.getElementById("medDate").value;
                const times = Array.from(
                  document.querySelectorAll('input[name="time"]:checked')
                ).map((t) => t.value);
    //æ¯å€‹è¢«é¸åˆ°çš„æ™‚é–“
                if (!name || !date || times.length === 0) {
                  alert("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½");
                  return;
                }

                // å¤šæ™‚æ®µç´€éŒ„ ä¸€ç­†ä¸€ç­†é€é€²è³‡æ–™åº«
                Promise.all(
                  times.map((time) =>
                    fetch("/record", {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                      },
                      body: JSON.stringify({
                        medicine_name: `${name}ï¼ˆ${translateTime(time)} - ${date}ï¼‰`,
                      }),
                    })
                  )
                )
                  .then(() => {
                    alert("ç´€éŒ„æˆåŠŸï¼");
                    location.reload(); // é‡æ–°æŠ“è³‡æ–™è®“ç•«é¢èˆ‡è³‡æ–™åº«åŒæ­¥
                  })
                  .catch((err) => {
                    console.error("æ–°å¢å¤±æ•—", err);
                    alert("æ–°å¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
                  });
              });
              function translateTime(time) {
            switch (time) {
              case "morning":
                return "æ—©ä¸Š";
              case "noon":
                return "ä¸­åˆ";
              case "evening":
                return "æ™šä¸Š";
              default:
                return time;
            }
          }
          //åˆªé™¤
          function deleteLog(id) { //idåœ¨htmlè£¡é¢æœ‰
          if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) return;

          fetch(`/record/${id}`, {
            method: "DELETE",
          })
            .then((res) => {
              if (!res.ok) throw new Error("åˆªé™¤å¤±æ•—");
              return res.text();
            })
            .then((msg) => {
              alert(msg);
              // å¾ç•«é¢ç§»é™¤è©²é …ç›®
              const item = document.querySelector(`.history-item[data-id='${id}']`);
              if (item) item.remove();
            })
            .catch((err) => {
              console.error("éŒ¯èª¤", err);
              alert("åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
            });
        }
  </script>
</html>
